<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard NPS 2.5 - Análise de Ofensores</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .risk-badge { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        .custom-checkbox { cursor: pointer; accent-color: #4f46e5; width: 16px; height: 16px; }
        .sort-icon { display: inline-block; width: 12px; margin-left: 4px; opacity: 0.5; }
        th:hover .sort-icon { opacity: 1; }
        
        /* Product Selection Styles */
        .btn-prod { transition: all 0.2s; border: 2px solid transparent; opacity: 0.6; filter: grayscale(0.8); }
        .btn-prod:hover { opacity: 0.9; filter: grayscale(0); }
        .btn-prod.selected { opacity: 1; filter: grayscale(0); transform: scale(1.02); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .btn-hdi.selected { border-color: #16a34a; background-color: #f0fdf4; color: #15803d; }
        .btn-yelum.selected { border-color: #ca8a04; background-color: #fefce8; color: #a16207; }

        /* Login Background Animation */
        @keyframes gradient-xy {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-gradient {
            background-size: 200% 200%;
            animation: gradient-xy 6s ease infinite;
        }
    </style>

    <!-- Módulo Único de Aplicação (Lógica + Firebase) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // CONFIGURAÇÃO FIREBASE
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCItfDagWuxFQnx036b7gIovTXABhbFmZQ",
            authDomain: "comunidade-ferramentas.firebaseapp.com",
            projectId: "comunidade-ferramentas",
            storageBucket: "comunidade-ferramentas.firebasestorage.app",
            messagingSenderId: "544906177736",
            appId: "1:544906177736:web:332554f4c76d9bd65549fd",
            measurementId: "G-WD4RY0531H"
        };

        // --- Estado Global ---
        let app, auth, db;
        let npsData = []; 
        let currentAnalista = localStorage.getItem('nps_user_name') || "";
        let selectedIds = new Set();
        let visibleItems = 10;
        let chartInstances = {};
        let activeChartFilter = null;
        let selectedRecordId = null;
        let sortConfig = { key: 'data', direction: 'desc' }; 
        const COLLECTION_NAME = "nps_records";
        const COLLECTION_LOGS = "nps_audit_logs"; 
        const RISK_KEYWORDS = ['procon', 'advogado', 'justiça', 'ameaça', 'reclame aqui', 'susep', 'processo'];

        // --- Inicialização Firebase ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase inicializado.");
        } catch (e) {
            console.error("Erro Init:", e);
            alert("Erro crítico ao iniciar Firebase.");
        }

        // --- Sistema de Auditoria ---
        async function logAudit(action, details) {
            if (!currentAnalista) return;
            try {
                await addDoc(collection(db, COLLECTION_LOGS), {
                    action: action, details: details, user: currentAnalista, timestamp: new Date().toISOString()
                });
            } catch(e) { console.error("Log error", e); }
        }

        // --- Funções Auxiliares ---
        function checkRisk(text) { return text && RISK_KEYWORDS.some(k => text.toLowerCase().includes(k)); }
        function parseDate(d) { 
            if(!d) return 0; 
            if (d.includes('-') && d.includes('T')) return new Date(d).getTime();
            if(d.includes('/')) { const p=d.split('/'); return new Date(p[2],p[1]-1,p[0]).getTime(); } 
            return 0; 
        }
        function getInitials(name) { return name ? name.substring(0,2).toUpperCase() : '--'; }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `p-4 rounded shadow-xl text-white text-sm bg-gray-800 border-l-4 border-indigo-500 toast-enter flex items-center gap-2 mb-2`;
            if(type==='warning') t.classList.replace('bg-gray-800', 'bg-red-600');
            if(type==='success') t.classList.replace('bg-gray-800', 'bg-green-600');
            t.innerHTML = `<span>${msg}</span>`;
            if(container) container.appendChild(t);
            setTimeout(()=>t.remove(), 4000);
        }

        // --- Lógica de Conexão ---
        async function initAppLogic() {
            try {
                await signInAnonymously(auth);
                startDataListener();
            } catch (error) {
                console.error("Auth Erro:", error);
                const loader = document.getElementById('loadingIndicator');
                if(loader) loader.innerHTML = `<span class="text-red-600 font-bold">Erro: ${error.message}</span>`;
            }
        }

        function startDataListener() {
            const q = query(collection(db, COLLECTION_NAME));
            onSnapshot(q, (snapshot) => {
                npsData = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                applySorting(); 
                refreshDashboard();
                const loader = document.getElementById('loadingIndicator');
                if(loader) loader.classList.add('hidden');
            });
        }

        function applySorting() {
            npsData.sort((a, b) => {
                let valA = a[sortConfig.key], valB = b[sortConfig.key];
                if (sortConfig.key === 'data') { valA = parseDate(valA); valB = parseDate(valB); }
                else if (['nota'].includes(sortConfig.key)) { valA = Number(valA)||0; valB = Number(valB)||0; }
                else { valA = (valA||'').toString().toLowerCase(); valB = (valB||'').toString().toLowerCase(); }
                return sortConfig.direction === 'asc' ? (valA < valB ? -1 : 1) : (valA > valB ? -1 : 1);
            });
        }

        window.sortTable = (key) => {
            sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'asc') ? 'desc' : 'asc';
            sortConfig.key = key;
            applySorting();
            refreshTable();
        };

        // --- Dashboard UI ---
        function refreshDashboard() {
            refreshKPIs();
            refreshTable();
            refreshCharts();
        }

        function refreshKPIs() {
            const total = npsData.length;
            const procedentes = npsData.filter(d => d.status === 'Procedente').length;
            const risco = npsData.filter(d => checkRisk(d.comentario)).length;
            const rede = npsData.filter(d => d.acaoRede && d.acaoRede !== 'Nenhuma').length;
            const prom = npsData.filter(d => d.nota >= 9).length;
            const det = npsData.filter(d => d.nota <= 6).length;
            const npsScore = total > 0 ? Math.round(((prom - det) / total) * 100) : 0;

            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-procedente').textContent = procedentes;
            document.getElementById('kpi-procedente-pct').textContent = total ? Math.round((procedentes/total)*100) + '%' : '0%';
            document.getElementById('kpi-risco').textContent = risco;
            document.getElementById('kpi-acao-rede').textContent = rede;
            
            const scoreEl = document.getElementById('kpi-nps-score');
            scoreEl.textContent = npsScore;
            const container = document.getElementById('kpi-score-container');
            container.className = `bg-white p-5 rounded-xl card-shadow border-l-4 flex flex-col justify-between hover:translate-y-[-2px] transition-transform ${npsScore >= 75 ? 'border-green-500' : npsScore >= 50 ? 'border-yellow-500' : npsScore >= 0 ? 'border-orange-500' : 'border-red-600'}`;
            document.getElementById('kpi-nps-text').className = `text-3xl font-bold mt-2 ${npsScore >= 75 ? 'text-green-600' : npsScore >= 50 ? 'text-yellow-600' : npsScore >= 0 ? 'text-orange-600' : 'text-red-700'}`;
        }

        function getFilteredData() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const start = document.getElementById('filterDateStart').valueAsDate;
            const end = document.getElementById('filterDateEnd').valueAsDate;

            return npsData.filter(i => {
                const textMatch = String(i.assistencia).includes(term) || (i.prestador||'').toLowerCase().includes(term) || (i.analista||'').toLowerCase().includes(term) || (i.fa||'').toLowerCase().includes(term) || (i.cidade||'').toLowerCase().includes(term);
                let statusMatch = true;
                if(status === 'RISCO') statusMatch = checkRisk(i.comentario);
                else if(status) statusMatch = i.status === status;
                
                let dateMatch = true;
                if (start || end) {
                    const d = parseDate(i.data);
                    if (d) { if (start && d < start.getTime()) dateMatch = false; if (end && d > end.getTime()) dateMatch = false; }
                }
                let chartMatch = true;
                if(activeChartFilter) {
                    if(activeChartFilter.type === 'motivo') chartMatch = i.motivo === activeChartFilter.value;
                    else if(activeChartFilter.type === 'prestador') chartMatch = i.prestador === activeChartFilter.value;
                }
                return textMatch && statusMatch && dateMatch && chartMatch;
            });
        }

        function refreshTable() {
            const filtered = getFilteredData();
            const tbody = document.getElementById('tableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            document.getElementById('showingCount').textContent = `Mostrando ${Math.min(visibleItems, filtered.length)} de ${filtered.length} registros`;
            document.getElementById('loadMoreBtn').classList.toggle('hidden', visibleItems >= filtered.length);

            filtered.slice(0, visibleItems).forEach(row => {
                const isRisk = checkRisk(row.comentario);
                const isSel = selectedIds.has(row.firebaseId);
                const tr = document.createElement('tr');
                tr.className = `group hover:bg-indigo-50 transition border-b border-gray-100 last:border-0 ${isRisk ? 'bg-red-50' : ''}`;
                let statusClass = row.status==='Procedente' ? 'bg-red-100 text-red-800' : row.status==='Improcedente' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                
                // Product Badge Logic
                let prodBadge = '';
                if(row.produto === 'HDI') prodBadge = '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200">HDI</span>';
                else if(row.produto === 'YELUM') prodBadge = '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">YELUM</span>';

                tr.innerHTML = `
                    <td class="p-4 text-center w-10"><input type="checkbox" class="custom-checkbox row-cb cursor-pointer" data-id="${row.firebaseId}" ${isSel ? 'checked' : ''} onchange="window.toggleSelectRow('${row.firebaseId}')"></td>
                    <td class="p-4 font-bold text-indigo-900 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            ${prodBadge} <span>#${row.assistencia}</span>
                            ${isRisk ? '<span class="risk-badge bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded">!</span>' : ''}
                        </div>
                    </td>
                    <td class="p-4 text-gray-500 whitespace-nowrap text-xs">${row.data || '-'}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${row.nota < 7 ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}">${row.nota}</span></td>
                    <td class="p-4 text-gray-600 text-xs truncate max-w-[120px]" title="${row.cidade} - ${row.uf}">${row.cidade ? `${row.cidade}-${row.uf}` : '-'}</td>
                    <td class="p-4 text-gray-600 text-xs max-w-[180px] truncate" title="${row.fa || ''} ${row.prestador}">
                        ${row.fa ? `<span class="font-bold text-indigo-700 bg-indigo-50 px-1 rounded mr-1">${row.fa}</span>` : ''} ${row.prestador}
                    </td>
                    <td class="p-4 text-gray-500 text-xs truncate max-w-[100px]">${row.tipoServico || '-'}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-medium border ${statusClass}">${row.status}</span></td>
                    <td class="p-4 text-right">
                        <div class="flex justify-end gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.viewDetails('${row.firebaseId}')" class="p-1 hover:text-indigo-600"><i data-lucide="eye" class="h-4 w-4"></i></button>
                            <button onclick="window.openFormModal('${row.firebaseId}')" class="p-1 hover:text-blue-600"><i data-lucide="edit-2" class="h-4 w-4"></i></button>
                            <button onclick="window.confirmSingleDelete('${row.firebaseId}')" class="p-1 hover:text-red-600"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- Gráficos (Bases Ofensoras - Procedentes) ---
        function refreshCharts() {
            const m = {}; const p = {};
            
            // Motivos (Geral)
            npsData.forEach(d => { 
                m[d.motivo||'Outros'] = (m[d.motivo||'Outros']||0)+1;
            });

            // Bases Ofensoras (Apenas Status Procedente)
            const procedentes = npsData.filter(d => d.status === 'Procedente');
            
            procedentes.forEach(d => {
                const prest = d.prestador || 'Desconhecido';
                p[prest] = (p[prest]||0)+1; 
            });
            
            const topP = Object.entries(p).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            drawChart('chartMotivos', 'bar', Object.keys(m), Object.values(m), (i)=> { activeChartFilter={type:'motivo',value:Object.keys(m)[i]}; refreshTable(); });
            
            // Gráfico de Bases Ofensoras em Vermelho
            drawChart('chartPrestadores', 'bar', topP.map(e => e[0]), topP.map(e => e[1]), (i)=> { activeChartFilter={type:'prestador',value:topP[i][0]}; refreshTable(); }, true, '#ef4444');
        }

        function drawChart(id, t, l, d, cb, horiz = false, color = '#6366f1') {
            const cvs = document.getElementById(id); if(!cvs) return;
            if(chartInstances[id]) chartInstances[id].destroy();
            chartInstances[id] = new Chart(cvs, {
                type: t, data:{labels:l,datasets:[{label:'Qtd',data:d,backgroundColor:color,borderRadius:4,barPercentage:0.6}]}, 
                options:{indexAxis: horiz?'y':'x', maintainAspectRatio:false, responsive: true, plugins:{legend:{display:false}}, onClick:(e,el)=>{if(cb&&el.length)cb(el[0].index)}, scales:{x:{grid:{display:false},beginAtZero:true},y:{beginAtZero:true,grid:{borderDash:[2,4]}}}}
            });
        }

        // --- Product Selection Logic ---
        window.selectProduct = function(prod) {
            document.getElementById('inpProduto').value = prod;
            const btnHDI = document.getElementById('btnHDI');
            const btnYelum = document.getElementById('btnYelum');
            
            if (prod === 'HDI') {
                btnHDI.classList.add('selected');
                btnYelum.classList.remove('selected');
            } else if (prod === 'YELUM') {
                btnYelum.classList.add('selected');
                btnHDI.classList.remove('selected');
            } else {
                btnHDI.classList.remove('selected');
                btnYelum.classList.remove('selected');
            }
        };

        // --- Modals & CRUD ---
        window.openFormModal = function(id = null) {
            document.getElementById('recordForm').reset();
            document.getElementById('inpAnalista').value = currentAnalista;
            window.selectProduct(''); // Reset product selection
            
            if(id) {
                const i = npsData.find(d => d.firebaseId === id);
                if(i) {
                    document.getElementById('firebaseId').value = id;
                    document.getElementById('inpAssistencia').value = i.assistencia;
                    document.getElementById('inpData').value = i.data;
                    document.getElementById('inpNota').value = i.nota;
                    document.getElementById('inpPrestador').value = i.prestador;
                    document.getElementById('inpFA').value = i.fa || '';
                    document.getElementById('inpTipoServico').value = i.tipoServico || '';
                    document.getElementById('inpCidade').value = i.cidade || '';
                    document.getElementById('inpUF').value = i.uf || '';
                    document.getElementById('inpStatus').value = i.status;
                    document.getElementById('inpMotivo').value = i.motivo;
                    document.getElementById('inpComentario').value = i.comentario;
                    document.getElementById('inpAcao').value = i.acaoRede;
                    window.selectProduct(i.produto || '');
                    document.getElementById('formModalTitle').innerHTML = `<i data-lucide="edit" class="h-4 w-4"></i> Editar Registro`;
                }
            } else { 
                document.getElementById('firebaseId').value = ""; 
                document.getElementById('formModalTitle').innerHTML = `<i data-lucide="plus-circle" class="h-4 w-4"></i> Novo Registro`;
            }
            document.getElementById('formModal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.handleFormSubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('firebaseId').value;
            const rec = {
                assistencia: document.getElementById('inpAssistencia').value,
                data: document.getElementById('inpData').value,
                nota: parseInt(document.getElementById('inpNota').value),
                analista: document.getElementById('inpAnalista').value || currentAnalista,
                produto: document.getElementById('inpProduto').value, 
                cidade: document.getElementById('inpCidade').value, 
                uf: document.getElementById('inpUF').value, 
                prestador: document.getElementById('inpPrestador').value,
                fa: document.getElementById('inpFA').value,
                tipoServico: document.getElementById('inpTipoServico').value,
                status: document.getElementById('inpStatus').value,
                motivo: document.getElementById('inpMotivo').value,
                comentario: document.getElementById('inpComentario').value,
                acaoRede: document.getElementById('inpAcao').value
            };
            window.closeModal('formModal');
            try {
                if(id) { await updateDoc(doc(db, COLLECTION_NAME, id), rec); logAudit('UPDATE', `ID: ${rec.assistencia}`); showToast("Atualizado!", "success"); } 
                else { rec.createdAt = new Date().toISOString(); await addDoc(collection(db, COLLECTION_NAME), rec); logAudit('CREATE', `ID: ${rec.assistencia}`); showToast("Criado!", "success"); }
            } catch(err) { showToast("Erro ao salvar.", "warning"); }
        };

        window.handleExcelUpload = function(e) {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader();
            r.onload = async function(evt) {
                try {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(!rows.length) { showToast("Vazio.", "warning"); return; }
                    showToast(`Importando ${rows.length}...`, "info");
                    const promises = rows.map(r => {
                        return addDoc(collection(db, COLLECTION_NAME), {
                            assistencia: r.ID || r.Assistencia || "000",
                            nota: r.Nota || r.nota || 0,
                            data: r.Data || r.data || "-",
                            status: r.Status || r.status || "Em Análise",
                            comentario: r.Comentario || r.Obs || "",
                            analista: currentAnalista,
                            prestador: r.Prestador || r.prestador || "",
                            tipoServico: r.TipoServico || r.Servico || "",
                            cidade: r.Cidade || "",
                            uf: r.UF || "",
                            produto: r.Produto || "",
                            motivo: r.Motivo || r.motivo || "",
                            fa: r.FA || r.fa || "",
                            acaoRede: r.Acao || r.acao || "",
                            createdAt: new Date().toISOString()
                        });
                    });
                    await Promise.all(promises);
                    logAudit('IMPORT', `Importou ${rows.length} registros.`);
                    showToast("Sucesso!", "success");
                } catch(err) { showToast("Erro importação.", "warning"); }
            };
            r.readAsArrayBuffer(f);
            e.target.value = '';
        };

        window.exportToExcel = function() {
            if(!npsData.length) { showToast("Sem dados.", "warning"); return; }
            const ws = XLSX.utils.json_to_sheet(npsData.map(d => ({
                "ID": d.assistencia, "Data": d.data, "Nota": d.nota, "Analista": d.analista, "Produto": d.produto,
                "FA": d.fa, "Prestador": d.prestador, "Cidade": d.cidade, "UF": d.uf, "Tipo Serviço": d.tipoServico, 
                "Status": d.status, "Motivo": d.motivo, "Ação": d.acaoRede, "Comentário": d.comentario, "Risco": checkRisk(d.comentario) ? "SIM" : "NÃO"
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Base NPS");
            XLSX.writeFile(wb, "NPS_Exportacao.xlsx");
            showToast("Download iniciado!", "success");
        };

        window.viewDetails = (id) => {
            const i = npsData.find(d => d.firebaseId === id);
            if(!i) return;
            
            // Format Product badge for modal
            let prodBadge = i.produto;
            if(i.produto === 'HDI') prodBadge = `<span class="px-2 py-1 bg-green-100 text-green-800 font-bold rounded">HDI</span>`;
            if(i.produto === 'YELUM') prodBadge = `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 font-bold rounded">YELUM</span>`;

            document.getElementById('detailsContent').innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="text-lg font-bold text-gray-800">#${i.assistencia}</span>
                    <div>${prodBadge || '<span class="text-gray-400 italic">Sem produto</span>'}</div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><p class="text-xs text-gray-500 font-bold uppercase">Prestador</p><p>${i.prestador}</p></div>
                    <div><p class="text-xs text-gray-500 font-bold uppercase">Local</p><p>${i.cidade || ''} - ${i.uf || ''}</p></div>
                    <div><p class="text-xs text-gray-500 font-bold uppercase">Serviço</p><p>${i.tipoServico || '-'}</p></div>
                    <div><p class="text-xs text-gray-500 font-bold uppercase">Motivo</p><p>${i.motivo}</p></div>
                    <div><p class="text-xs text-gray-500 font-bold uppercase">Analista</p><p>${i.analista}</p></div>
                    <div><p class="text-xs text-gray-500 font-bold uppercase">Ação Rede</p><p>${i.acaoRede || '-'}</p></div>
                </div>
                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <p class="text-xs text-gray-500 font-bold mb-2 uppercase">Comentário Técnico</p>
                    <p class="text-sm text-gray-800 leading-relaxed">${i.comentario}</p>
                </div>
            `;
            document.getElementById('detailsModal').classList.remove('hidden');
        };

        // Standard Window Functions
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleSelectRow = (id) => { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); window.updateBulkUI(); };
        window.toggleSelectAll = () => { const c = document.getElementById('selectAllCheckbox').checked; document.querySelectorAll('.row-cb').forEach(cb => { cb.checked = c; if(c) selectedIds.add(cb.getAttribute('data-id')); else selectedIds.delete(cb.getAttribute('data-id')); }); window.updateBulkUI(); };
        window.updateBulkUI = () => { const btn = document.getElementById('btnDeleteSelected'); if(selectedIds.size > 0) { btn.classList.remove('hidden'); btn.classList.add('flex'); document.getElementById('selectedCountText').textContent = `Excluir (${selectedIds.size})`; } else { btn.classList.add('hidden'); btn.classList.remove('flex'); } };
        window.loadMore = () => { visibleItems += 10; refreshTable(); };
        window.clearFilters = () => { document.getElementById('searchInput').value=''; document.getElementById('filterStatus').value=''; window.clearChartFilter(); };
        window.clearChartFilter = () => { activeChartFilter=null; refreshTable(); };
        window.confirmSingleDelete = (id) => { selectedRecordId = id; document.getElementById('confirmModal').classList.remove('hidden'); document.getElementById('confirmBtnAction').onclick = async () => { window.closeModal('confirmModal'); await deleteDoc(doc(db, COLLECTION_NAME, selectedRecordId)); logAudit('DELETE', `ID: ${selectedRecordId}`); showToast('Excluído'); } };
        window.confirmBatchDelete = () => { if(!selectedIds.size) return; document.getElementById('confirmModal').classList.remove('hidden'); document.getElementById('confirmBtnAction').onclick = async () => { window.closeModal('confirmModal'); const batch = writeBatch(db); selectedIds.forEach(id => batch.delete(doc(db, COLLECTION_NAME, id))); await batch.commit(); logAudit('BATCH DELETE', `${selectedIds.size} itens`); showToast('Excluídos'); selectedIds.clear(); window.updateBulkUI(); document.getElementById('selectAllCheckbox').checked = false; } };
        window.duplicateRecord = async (id) => { const orig = npsData.find(d=>d.firebaseId===id); if(orig && confirm("Duplicar?")) { const copy={...orig}; delete copy.firebaseId; copy.createdAt=new Date().toISOString(); copy.analista=currentAnalista; await addDoc(collection(db, COLLECTION_NAME), copy); showToast("Duplicado"); } };
        window.downloadTemplate = () => { const ws = XLSX.utils.json_to_sheet([{"Assistencia":"123","Data":"01/01/2026","Nota":0,"Produto":"HDI","Cidade":"SP","UF":"SP","Prestador":"X","TipoServico":"Encanador"}]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Modelo"); XLSX.writeFile(wb, "Modelo.xlsx"); };
        
        // Audit
        window.openAuditModal = function() {
            const m = document.getElementById('auditModal');
            const b = document.getElementById('auditBody');
            b.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Carregando...</td></tr>';
            m.classList.remove('hidden');
            const q = query(collection(db, COLLECTION_LOGS), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(q, (s) => {
                b.innerHTML = s.empty ? '<tr><td colspan="4" class="p-4 text-center">Sem logs.</td></tr>' : '';
                s.forEach(d => {
                    const l = d.data();
                    b.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 text-xs text-gray-500">${new Date(l.timestamp).toLocaleString()}</td><td class="p-3 text-xs font-bold">${l.user}</td><td class="p-3 text-xs log-${l.action.split(' ')[0]}">${l.action}</td><td class="p-3 text-xs text-gray-600 truncate max-w-[200px]">${l.details}</td></tr>`;
                });
            });
        };

        // Auth
        window.performLogin = function() {
            const n = document.getElementById('loginName').value;
            if(!n) return alert("Nome obrigatório");
            currentAnalista = n;
            localStorage.setItem('nps_user_name', n);
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('userNameDisplay').textContent = getInitials(n);
            initAppLogic();
        };
        window.logout = () => { if(confirm("Sair?")) { localStorage.removeItem('nps_user_name'); location.reload(); } };

        if(currentAnalista) {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('userNameDisplay').textContent = getInitials(currentAnalista);
            initAppLogic();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            ['searchInput','filterStatus','filterDateStart','filterDateEnd'].forEach(id=>document.getElementById(id).addEventListener('input',()=>refreshTable()));
        });
    </script>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900">
        <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 24px 24px;"></div>
        <div class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl w-full max-w-md p-8 text-center animate-fade-in relative z-10 border border-white/20">
            <div class="mb-8">
                <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                    <i data-lucide="shield-check" class="h-10 w-10 text-indigo-600"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Acesso ao Dashboard</h2>
                <p class="text-gray-500 mt-2 text-sm font-medium">Gestão de Qualidade & NPS</p>
            </div>
            <div class="space-y-5 text-left">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="user" class="h-5 w-5 text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Analista</label>
                    <input type="text" id="loginName" placeholder="Seu Nome Completo" class="w-full pl-12 pr-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all shadow-sm font-medium">
                </div>
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none mt-6">
                        <i data-lucide="key-round" class="h-5 w-5 text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Código de Acesso</label>
                    <input type="password" id="loginPin" maxlength="4" placeholder="••••" class="w-full pl-12 pr-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all shadow-sm text-lg tracking-widest font-bold">
                </div>
                <button onclick="performLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2 mt-4">
                    <span>Entrar no Sistema</span>
                    <i data-lucide="arrow-right" class="h-5 w-5"></i>
                </button>
            </div>
            <p class="mt-8 text-xs text-gray-400">Ambiente Seguro • Versão 2.4</p>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-xl p-6 text-center w-full max-w-sm"><h3 class="font-bold text-lg mb-4">Confirmar?</h3><p id="confirmText" class="mb-6 text-sm text-gray-500"></p><div class="flex gap-2 justify-center"><button onclick="closeModal('confirmModal')" class="px-4 py-2 bg-gray-200 rounded">Cancelar</button><button id="confirmBtnAction" class="px-4 py-2 bg-red-600 text-white rounded">Confirmar</button></div></div></div>
    <div id="auditModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-xl w-full max-w-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b flex justify-between font-bold"><span>Histórico</span><button onclick="closeModal('auditModal')">X</button></div><div class="overflow-auto flex-grow"><table class="w-full"><thead class="bg-gray-50 text-xs text-gray-500"><tr><th class="p-3">Data</th><th class="p-3">Usuário</th><th class="p-3">Ação</th><th class="p-3">Detalhes</th></tr></thead><tbody id="auditBody"></tbody></table></div></div></div>
    <div id="detailsModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-xl w-full max-w-2xl flex flex-col max-h-[90vh]"><div class="p-4 border-b flex justify-between font-bold"><span>Detalhes</span><button onclick="closeModal('detailsModal')">X</button></div><div class="p-6 overflow-auto" id="detailsContent"></div></div></div>

    <!-- Form Modal -->
    <div id="formModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 bg-indigo-600 text-white flex justify-between items-center flex-none">
                <h3 class="font-bold flex items-center gap-2" id="formModalTitle">Registro</h3>
                <button onclick="closeModal('formModal')" class="text-indigo-200 hover:text-white"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <form id="recordForm" onsubmit="handleFormSubmit(event)" class="p-6 space-y-4 overflow-y-auto custom-scroll flex-grow">
                <input type="hidden" id="firebaseId"><input type="hidden" id="editIndex"><input type="hidden" id="inpProduto">
                
                <!-- Product Selection -->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-700 mb-2 uppercase">Produto (Seguradora)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" id="btnHDI" onclick="selectProduct('HDI')" class="btn-prod btn-hdi py-3 rounded-lg font-bold bg-green-50 text-green-700 border border-green-200 flex items-center justify-center gap-2">
                            <i data-lucide="shield" class="w-4 h-4"></i> HDI
                        </button>
                        <button type="button" id="btnYelum" onclick="selectProduct('YELUM')" class="btn-prod btn-yelum py-3 rounded-lg font-bold bg-yellow-50 text-yellow-700 border border-yellow-200 flex items-center justify-center gap-2">
                            <i data-lucide="sun" class="w-4 h-4"></i> YELUM
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">ID Assistência</label>
                        <input type="number" id="inpAssistencia" required class="w-full border p-2 rounded text-sm bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Data</label>
                        <input type="text" id="inpData" placeholder="DD/MM/AAAA" class="w-full border p-2 rounded text-sm">
                    </div>
                </div>
                
                <!-- Location -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Cidade</label>
                        <input type="text" id="inpCidade" class="w-full border p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">UF</label>
                        <input type="text" id="inpUF" maxlength="2" placeholder="SP" class="w-full border p-2 rounded text-sm uppercase">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Nota NPS</label>
                        <input type="number" id="inpNota" required min="0" max="10" class="w-full border p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Analista</label>
                        <input type="text" id="inpAnalista" readonly class="w-full border p-2 rounded text-sm bg-gray-100 text-gray-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Cód. FA</label>
                        <input type="text" id="inpFA" class="w-full border p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Prestador</label>
                        <input type="text" id="inpPrestador" class="w-full border p-2 rounded text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Tipo de Serviço</label>
                    <input type="text" id="inpTipoServico" placeholder="Ex: Linha Branca" class="w-full border p-2 rounded text-sm">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Status</label>
                        <select id="inpStatus" class="w-full border p-2 rounded text-sm bg-white">
                            <option value="Procedente">Procedente</option>
                            <option value="Improcedente">Improcedente</option>
                            <option value="Em Análise">Em Análise</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Motivo</label>
                        <input type="text" id="inpMotivo" class="w-full border p-2 rounded text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Comentário Técnico</label>
                    <textarea id="inpComentario" rows="3" class="w-full border p-2 rounded text-sm resize-none"></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Ação na Rede</label>
                    <input type="text" id="inpAcao" class="w-full border p-2 rounded text-sm">
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 font-bold shadow-md">Salvar Registro</button>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3"></div>

    <!-- Nav -->
    <nav class="bg-indigo-900 text-white shadow-lg z-30 flex-none">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-indigo-700 p-2 rounded-lg"><i data-lucide="cloud" class="h-6 w-6 text-green-400"></i></div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide">NPS Cloud 2.3</h1>
                    <p class="text-xs text-indigo-300 flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Online</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="openAuditModal()" class="flex items-center space-x-2 bg-indigo-800 hover:bg-indigo-700 px-3 py-1.5 rounded-lg text-xs border border-indigo-700 text-indigo-100"><i data-lucide="history" class="h-4 w-4"></i>Logs</button>
                <div class="h-6 w-px bg-indigo-700 mx-1"></div>
                <button onclick="downloadTemplate()" class="hidden md:flex items-center space-x-2 bg-indigo-800 hover:bg-indigo-700 px-3 py-1.5 rounded-lg text-xs border border-indigo-700 text-indigo-100"><i data-lucide="download" class="h-4 w-4"></i>Modelo</button>
                <button onclick="exportToExcel()" class="hidden md:flex items-center space-x-2 bg-green-700 hover:bg-green-600 px-3 py-1.5 rounded-lg text-xs shadow-sm border border-green-600"><i data-lucide="file-spreadsheet" class="h-4 w-4"></i>Excel</button>
                <div class="h-8 w-1 bg-indigo-700 mx-2"></div>
                <button onclick="logout()" class="flex items-center space-x-2 bg-red-800/80 hover:bg-red-700 px-3 py-1.5 rounded-lg text-xs" title="Sair"><i data-lucide="log-out" class="h-4 w-4"></i></button>
                <div id="userNameDisplay" class="h-9 w-9 rounded-full bg-indigo-500 flex items-center justify-center border-2 border-indigo-400 font-bold text-xs cursor-help">--</div>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <main class="container mx-auto px-4 py-6 flex-grow overflow-y-auto custom-scroll">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="layout-dashboard" class="h-5 w-5 text-indigo-600"></i>Visão Estratégica</h2>
            <div class="flex space-x-2 w-full md:w-auto">
                <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelUpload(event)">
                <button id="btnDeleteSelected" onclick="confirmBatchDelete()" class="hidden flex items-center bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-bold border border-red-200"><i data-lucide="trash-2" class="h-4 w-4 mr-2"></i><span id="selectedCountText">Excluir</span></button>
                <button onclick="document.getElementById('excelInput').click()" class="flex items-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium shadow-sm"><i data-lucide="upload-cloud" class="h-4 w-4 mr-2 text-indigo-600"></i>Importar</button>
                <button onclick="openFormModal()" class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md"><i data-lucide="plus-circle" class="h-4 w-4 mr-2"></i>Novo Registro</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white p-5 rounded-xl card-shadow border-l-4 border-gray-400 flex flex-col justify-between"><div class="flex justify-between"><p class="text-xs text-gray-500 font-bold uppercase">Total</p><i data-lucide="file-text" class="h-5 w-5 text-gray-300"></i></div><h3 class="text-3xl font-bold mt-2" id="kpi-total">0</h3></div>
            <div id="kpi-score-container" class="bg-white p-5 rounded-xl card-shadow border-l-4 border-blue-500 flex flex-col justify-between"><div class="flex justify-between"><p class="text-xs text-gray-500 font-bold uppercase">NPS Real</p><i data-lucide="activity" class="h-5 w-5 text-blue-300"></i></div><h3 class="text-3xl font-bold mt-2 text-blue-600" id="kpi-nps-text"><span id="kpi-nps-score">0</span></h3></div>
            <div class="bg-white p-5 rounded-xl card-shadow border-l-4 border-red-500 flex flex-col justify-between"><div class="flex justify-between"><p class="text-xs text-gray-500 font-bold uppercase">Procedentes</p><span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold" id="kpi-procedente-pct">0%</span></div><h3 class="text-3xl font-bold mt-2 text-red-600" id="kpi-procedente">0</h3></div>
            <div class="bg-white p-5 rounded-xl card-shadow border-l-4 border-orange-500 flex flex-col justify-between"><div class="flex justify-between"><p class="text-xs text-gray-500 font-bold uppercase">Risco</p><i data-lucide="alert-triangle" class="h-5 w-5 text-orange-500 animate-pulse"></i></div><h3 class="text-3xl font-bold mt-2 text-orange-600" id="kpi-risco">0</h3></div>
            <div class="bg-white p-5 rounded-xl card-shadow border-l-4 border-yellow-500 flex flex-col justify-between"><div class="flex justify-between"><p class="text-xs text-gray-500 font-bold uppercase">Ações</p><i data-lucide="zap" class="h-5 w-5 text-yellow-500"></i></div><h3 class="text-3xl font-bold mt-2" id="kpi-acao-rede">0</h3></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-xl card-shadow border border-gray-100"><h3 class="text-sm font-bold uppercase text-gray-500 mb-6 flex justify-between"><span><i data-lucide="bar-chart-2" class="h-4 w-4 inline mr-2"></i> Motivos</span><button onclick="clearChartFilter()" class="text-xs text-indigo-600 underline">Limpar</button></h3><div class="chart-container" style="height: 280px;"><canvas id="chartMotivos"></canvas></div></div>
            <div class="bg-white p-6 rounded-xl card-shadow border border-gray-100"><h3 class="text-sm font-bold uppercase text-gray-500 mb-6"><i data-lucide="alert-triangle" class="h-4 w-4 inline mr-2"></i> Bases Ofensoras (Procedentes)</h3><div class="chart-container" style="height: 280px;"><canvas id="chartPrestadores"></canvas></div></div>
        </div>

        <div class="bg-white rounded-xl card-shadow overflow-hidden mb-8 border border-gray-200">
            <div class="p-5 border-b border-gray-100 bg-gray-50"><div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center"><div class="md:col-span-5 relative"><i data-lucide="search" class="absolute left-3 top-2.5 h-4 w-4 text-gray-400"></i><input type="text" id="searchInput" placeholder="Buscar..." class="w-full pl-10 pr-4 py-2 rounded-lg border text-sm"></div><div class="md:col-span-3"><select id="filterStatus" class="w-full py-2 px-3 rounded-lg border text-sm"><option value="">Todos Status</option><option value="Procedente">Em Análise</option><option value="Procedente">Procedente</option><option value="RISCO">⚠️ Risco</option></select></div><div class="md:col-span-4 flex gap-2"><input type="date" id="filterDateStart" class="w-full text-sm border p-2 rounded-lg"><input type="date" id="filterDateEnd" class="w-full text-sm border p-2 rounded-lg"></div></div></div>
            <div class="overflow-x-auto custom-scroll relative min-h-[300px]">
                <div id="loadingIndicator" class="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center font-bold text-gray-500"><i data-lucide="loader-2" class="animate-spin h-8 w-8 mb-2 text-indigo-600"></i><span>Sincronizando...</span></div>
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 text-xs uppercase font-bold sticky top-0 z-10 shadow-sm">
                        <tr><th class="p-4 w-10 text-center"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="custom-checkbox"></th><th class="p-4 cursor-pointer hover:bg-gray-200" onclick="window.sortTable('assistencia')">ID <i data-lucide="arrow-up-down" class="sort-icon"></i></th><th class="p-4 cursor-pointer hover:bg-gray-200" onclick="window.sortTable('data')">Data <i data-lucide="arrow-up-down" class="sort-icon"></i></th><th class="p-4">Nota</th><th class="p-4">Local</th><th class="p-4">FA / Prestador</th><th class="p-4">Serviço</th><th class="p-4 cursor-pointer hover:bg-gray-200" onclick="window.sortTable('status')">Status <i data-lucide="arrow-up-down" class="sort-icon"></i></th><th class="p-4 text-right">Ações</th></tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm divide-y divide-gray-100 bg-white"></tbody>
                </table>
            </div>
            <div class="p-4 border-t border-gray-100 text-center bg-gray-50 flex flex-col items-center"><p class="text-xs text-gray-500 mb-2 font-medium" id="showingCount">Carregando...</p><button id="loadMoreBtn" onclick="loadMore()" class="text-indigo-600 text-xs font-bold hidden px-6 py-2 border rounded-full bg-white shadow-sm">Carregar Mais</button></div>
        </div>
    </main>
</body>
</html>
