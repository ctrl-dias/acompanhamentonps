<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard NPS 4.7 - Gestão Eficiente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Modern Card Styles */
        .card-modern {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .risk-badge { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        
        /* Inputs & Checkboxes */
        .custom-checkbox { cursor: pointer; accent-color: #6366f1; width: 18px; height: 18px; border-radius: 4px; }
        .sort-icon { display: inline-block; width: 12px; margin-left: 4px; opacity: 0.3; transition: opacity 0.2s; }
        th:hover .sort-icon { opacity: 1; }
        
        /* Product Selection Styles - Modernized */
        .btn-prod { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid #e2e8f0; 
            font-size: 0.75rem; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }
        .btn-prod:hover { border-color: #cbd5e1; background-color: #f8fafc; }
        .btn-prod.selected { 
            font-weight: 700;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid transparent;
        }
        
        .btn-hdi.selected { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); 
            color: #14532d; 
        }
        .btn-yelum.selected { 
            background: linear-gradient(135deg, #fef9c3 0%, #fde047 100%); 
            color: #713f12; 
        }
    </style>

    <!-- Módulo Único de Aplicação (Lógica + Firebase) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // CONFIGURAÇÃO FIREBASE
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCItfDagWuxFQnx036b7gIovTXABhbFmZQ",
            authDomain: "comunidade-ferramentas.firebaseapp.com",
            projectId: "comunidade-ferramentas",
            storageBucket: "comunidade-ferramentas.firebasestorage.app",
            messagingSenderId: "544906177736",
            appId: "1:544906177736:web:332554f4c76d9bd65549fd",
            measurementId: "G-WD4RY0531H"
        };

        // --- Estado Global ---
        let app, auth, db;
        let npsData = []; 
        let currentAnalista = localStorage.getItem('nps_user_name') || "";
        let selectedIds = new Set();
        let visibleItems = 10;
        let chartInstances = {};
        let activeChartFilter = null;
        let selectedRecordId = null;
        let sortConfig = { key: 'data', direction: 'desc' }; 
        const COLLECTION_NAME = "nps_records";
        const COLLECTION_LOGS = "nps_audit_logs"; 
        const RISK_KEYWORDS = ['procon', 'advogado', 'justiça', 'ameaça', 'reclame aqui', 'susep', 'processo'];

        // --- Inicialização Firebase ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase inicializado.");
        } catch (e) {
            console.error("Erro Init:", e);
            alert("Erro crítico ao iniciar Firebase.");
        }

        // --- Sistema de Auditoria ---
        async function logAudit(action, details) {
            if (!currentAnalista) return;
            try {
                await addDoc(collection(db, COLLECTION_LOGS), {
                    action: action, details: details, user: currentAnalista, timestamp: new Date().toISOString()
                });
            } catch(e) { console.error("Log error", e); }
        }

        // --- Funções Auxiliares ---
        function checkRisk(text) { return text && RISK_KEYWORDS.some(k => text.toLowerCase().includes(k)); }
        function parseDate(d) { 
            if(!d) return 0; 
            if (d.includes('-') && d.includes('T')) return new Date(d).getTime();
            if(d.includes('/')) { const p=d.split('/'); return new Date(p[2],p[1]-1,p[0]).getTime(); } 
            return 0; 
        }
        function getInitials(name) { return name ? name.substring(0,2).toUpperCase() : '--'; }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            // Toast Moderno
            t.className = `p-4 rounded-xl shadow-2xl text-white text-sm backdrop-blur-md border border-white/10 toast-enter flex items-center gap-3 mb-3 transform transition-all duration-300 hover:scale-105`;
            
            if(type==='info') t.classList.add('bg-slate-800/90');
            if(type==='warning') t.classList.add('bg-orange-600/90');
            if(type==='success') t.classList.add('bg-emerald-600/90');
            
            let icon = '';
            if(type==='success') icon = '<i data-lucide="check-circle" class="w-5 h-5"></i>';
            else if(type==='warning') icon = '<i data-lucide="alert-triangle" class="w-5 h-5"></i>';
            else icon = '<i data-lucide="info" class="w-5 h-5"></i>';

            t.innerHTML = `${icon}<span class="font-medium">${msg}</span>`;
            if(container) container.appendChild(t);
            lucide.createIcons();
            setTimeout(()=> {
                t.style.opacity = '0';
                t.style.transform = 'translateX(100%)';
                setTimeout(() => t.remove(), 300);
            }, 4000);
        }

        // --- Lógica de Conexão ---
        async function initAppLogic() {
            try {
                await signInAnonymously(auth);
                startDataListener();
            } catch (error) {
                console.error("Auth Erro:", error);
                const loader = document.getElementById('loadingIndicator');
                if(loader) loader.innerHTML = `<span class="text-red-600 font-bold">Erro: ${error.message}</span>`;
            }
        }

        function startDataListener() {
            const q = query(collection(db, COLLECTION_NAME));
            onSnapshot(q, (snapshot) => {
                npsData = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                applySorting(); 
                refreshDashboard();
                const loader = document.getElementById('loadingIndicator');
                if(loader) loader.classList.add('hidden');
            });
        }

        function applySorting() {
            npsData.sort((a, b) => {
                let valA = a[sortConfig.key], valB = b[sortConfig.key];
                if (sortConfig.key === 'data') { valA = parseDate(valA); valB = parseDate(valB); }
                else if (['nota'].includes(sortConfig.key)) { valA = Number(valA)||0; valB = Number(valB)||0; }
                else { valA = (valA||'').toString().toLowerCase(); valB = (valB||'').toString().toLowerCase(); }
                return sortConfig.direction === 'asc' ? (valA < valB ? -1 : 1) : (valA > valB ? -1 : 1);
            });
        }

        window.sortTable = (key) => {
            sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'asc') ? 'desc' : 'asc';
            sortConfig.key = key;
            applySorting();
            refreshTable();
        };

        // --- Dashboard UI ---
        function refreshDashboard() {
            refreshKPIs();
            refreshTable();
            refreshCharts();
        }

        function refreshKPIs() {
            const total = npsData.length;
            const procedentes = npsData.filter(d => d.status === 'Procedente').length;
            const improcedentes = npsData.filter(d => d.status === 'Improcedente').length; // Nova Métrica

            // KPI 1 & 2
            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-procedente').textContent = procedentes;
            document.getElementById('kpi-procedente-pct').textContent = total ? Math.round((procedentes/total)*100) + '%' : '0%';
            
            // KPI 3: Improcedentes
            document.getElementById('kpi-improcedente').textContent = improcedentes;
            document.getElementById('kpi-improcedente-pct').textContent = total ? Math.round((improcedentes/total)*100) + '%' : '0%';
        }

        function getFilteredData() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const notaFilter = document.getElementById('filterNota').value;
            const start = document.getElementById('filterDateStart').valueAsDate;
            const end = document.getElementById('filterDateEnd').valueAsDate;

            return npsData.filter(i => {
                const textMatch = String(i.assistencia).includes(term) || (i.prestador||'').toLowerCase().includes(term) || (i.analista||'').toLowerCase().includes(term) || (i.fa||'').toLowerCase().includes(term) || (i.cidade||'').toLowerCase().includes(term);
                
                let statusMatch = true;
                if(status) statusMatch = i.status === status;
                
                let notaMatch = true;
                if(notaFilter !== "") notaMatch = i.nota == notaFilter;

                let dateMatch = true;
                if (start || end) {
                    const d = parseDate(i.data);
                    if (d) { if (start && d < start.getTime()) dateMatch = false; if (end && d > end.getTime()) dateMatch = false; }
                }
                
                let chartMatch = true;
                if(activeChartFilter) {
                    if(activeChartFilter.type === 'motivo') chartMatch = i.motivo === activeChartFilter.value;
                    else if(activeChartFilter.type === 'prestador') chartMatch = i.prestador === activeChartFilter.value;
                }
                
                return textMatch && statusMatch && notaMatch && dateMatch && chartMatch;
            });
        }

        // Função Ferramenta: Copiar Resumo
        window.copySummary = function(id) {
            const d = npsData.find(i => i.firebaseId === id);
            if(!d) return;
            const text = `*Resumo NPS #${d.assistencia}*\nPrestador: ${d.prestador}\nNota: ${d.nota}\nStatus: ${d.status}\nMotivo: ${d.motivo}\nAnalista: ${d.analista}\n\nObs: ${d.comentario}`;
            navigator.clipboard.writeText(text).then(() => showToast("Resumo copiado!", "success"));
        };

        function refreshTable() {
            const filtered = getFilteredData();
            const tbody = document.getElementById('tableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            document.getElementById('showingCount').textContent = `Mostrando ${Math.min(visibleItems, filtered.length)} de ${filtered.length} registros`;
            document.getElementById('loadMoreBtn').classList.toggle('hidden', visibleItems >= filtered.length);

            filtered.slice(0, visibleItems).forEach(row => {
                const isRisk = checkRisk(row.comentario) || checkRisk(row.vozDoCliente);
                const isSel = selectedIds.has(row.firebaseId);
                const tr = document.createElement('tr');
                tr.className = `group hover:bg-slate-50 transition-colors duration-200 border-b border-slate-100 last:border-0 ${isRisk ? 'bg-red-50/50 hover:bg-red-50' : ''}`;
                
                let statusClass = 'bg-slate-100 text-slate-600';
                if(row.status === 'Procedente') statusClass = 'bg-rose-100 text-rose-700';
                else if(row.status === 'Improcedente') statusClass = 'bg-emerald-100 text-emerald-700';
                else if(row.status === 'Neutra') statusClass = 'bg-indigo-50 text-indigo-700 border-indigo-100';
                else if(row.status === 'Em Análise') statusClass = 'bg-amber-100 text-amber-700';
                
                let prodBadge = '';
                if(row.produto === 'HDI') prodBadge = '<span class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-emerald-50 text-emerald-600 border border-emerald-100 shadow-sm">HDI</span>';
                else if(row.produto === 'YELUM') prodBadge = '<span class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-amber-50 text-amber-600 border border-amber-100 shadow-sm">YELUM</span>';

                let noteClass = 'bg-emerald-50 text-emerald-600 border-emerald-100';
                if(row.nota < 7) noteClass = 'bg-rose-50 text-rose-600 border-rose-100';
                else if (row.nota < 9) noteClass = 'bg-amber-50 text-amber-600 border-amber-100';

                tr.innerHTML = `
                    <td class="p-4 text-center w-12"><input type="checkbox" class="custom-checkbox row-cb" data-id="${row.firebaseId}" ${isSel ? 'checked' : ''} onchange="window.toggleSelectRow('${row.firebaseId}')"></td>
                    <td class="p-4 font-semibold text-slate-700 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            ${prodBadge} <span class="tracking-tight">#${row.assistencia}</span>
                            ${isRisk ? '<span class="risk-badge bg-rose-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold shadow-sm">!</span>' : ''}
                        </div>
                    </td>
                    <td class="p-4 text-slate-500 whitespace-nowrap text-xs font-medium">${row.data || '-'}</td>
                    <td class="p-4"><span class="px-2.5 py-1 rounded-lg text-xs font-bold border ${noteClass}">${row.nota}</span></td>
                    <td class="p-4 text-slate-600 text-xs truncate max-w-[120px] font-medium" title="${row.cidade} - ${row.uf}">${row.cidade ? `${row.cidade}-${row.uf}` : '-'}</td>
                    <td class="p-4 text-slate-600 text-xs max-w-[180px] truncate" title="${row.fa || ''} ${row.prestador}">
                        ${row.fa ? `<span class="font-bold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 mr-1">${row.fa}</span>` : ''} ${row.prestador}
                    </td>
                    <td class="p-4 text-slate-500 text-xs truncate max-w-[100px]">${row.tipoServico || '-'}</td>
                    <td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-semibold border border-transparent ${statusClass}">${row.status}</span></td>
                    <td class="p-4 text-slate-600 text-xs truncate max-w-[120px] font-medium" title="${row.analista}">${row.analista || '-'}</td>
                    <td class="p-4 text-right">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                            <button onclick="window.copySummary('${row.firebaseId}')" class="p-1.5 rounded-md hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition-colors" title="Copiar Resumo"><i data-lucide="clipboard-copy" class="h-4 w-4"></i></button>
                            <button onclick="window.viewDetails('${row.firebaseId}')" class="p-1.5 rounded-md hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 transition-colors"><i data-lucide="eye" class="h-4 w-4"></i></button>
                            <button onclick="window.openFormModal('${row.firebaseId}')" class="p-1.5 rounded-md hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-colors"><i data-lucide="edit-2" class="h-4 w-4"></i></button>
                            <button onclick="window.confirmSingleDelete('${row.firebaseId}')" class="p-1.5 rounded-md hover:bg-rose-50 text-slate-400 hover:text-rose-600 transition-colors"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- Gráficos (Otimizado: Top 5 + Outros) ---
        function refreshCharts() {
            const m = {}; const p = {};
            
            // FILTRAR APENAS PROCEDENTES PARA O GRÁFICO DE MOTIVOS
            const procedentesData = npsData.filter(d => d.status === 'Procedente');

            // Normalizar os motivos para evitar duplicidade de strings sujas
            // Usamos procedentesData aqui
            procedentesData.forEach(d => { 
                const motivo = (d.motivo || 'Outros').trim();
                m[motivo] = (m[motivo]||0)+1; 
            });

            // Lógica Inteligente para Motivos (Pareto: Top 5 + Outros)
            const sortedMotivos = Object.entries(m).sort((a,b) => b[1] - a[1]);
            let finalMotivosLabels = [];
            let finalMotivosData = [];
            
            // Pega os Top 5
            const top5 = sortedMotivos.slice(0, 5);
            top5.forEach(item => {
                finalMotivosLabels.push(item[0]);
                finalMotivosData.push(item[1]);
            });

            // Agrupa o restante em "Outros"
            if (sortedMotivos.length > 5) {
                const outrosCount = sortedMotivos.slice(5).reduce((acc, curr) => acc + curr[1], 0);
                finalMotivosLabels.push('Outros (Diversos)');
                finalMotivosData.push(outrosCount);
            }

            // Bases Ofensoras (Também Procedentes - Já estava assim na lógica anterior mas reforçando)
            procedentesData.forEach(d => { const prest = d.prestador || 'Desconhecido'; p[prest] = (p[prest]||0)+1; });
            const topP = Object.entries(p).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            // Cores Modernas
            const colorMotivo = '#6366f1'; // Indigo 500
            const colorPrestador = '#f43f5e'; // Rose 500

            // Gráfico Horizontal Limpo (Motivos)
            drawChart('chartMotivos', 'bar', finalMotivosLabels, finalMotivosData, (i)=> { 
                // Filtro especial para clicar em "Outros" não quebrar
                const label = finalMotivosLabels[i];
                if(label !== 'Outros (Diversos)') {
                    activeChartFilter={type:'motivo',value:label}; 
                    refreshTable(); 
                } else {
                    showToast("Filtre pela lista para ver detalhes de 'Outros'", "info");
                }
            }, true, colorMotivo);
            
            // Gráfico Vertical Bases Ofensoras
            drawChart('chartPrestadores', 'bar', topP.map(e => e[0]), topP.map(e => e[1]), (i)=> { activeChartFilter={type:'prestador',value:topP[i][0]}; refreshTable(); }, false, colorPrestador);
        }

        function drawChart(id, t, l, d, cb, horiz = false, color = '#6366f1') {
            const cvs = document.getElementById(id); if(!cvs) return;
            if(chartInstances[id]) chartInstances[id].destroy();
            
            const valueAxis = horiz ? 'x' : 'y';
            const categoryAxis = horiz ? 'y' : 'x';

            // Configuração do Chart.js com design mais limpo
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';

            chartInstances[id] = new Chart(cvs, {
                type: t, 
                data:{
                    labels:l,
                    datasets:[{
                        label:'Qtd',
                        data:d,
                        backgroundColor: color,
                        hoverBackgroundColor: horiz ? '#4f46e5' : '#e11d48',
                        borderRadius: 6,
                        barPercentage: 0.6,
                        borderSkipped: false
                    }]
                }, 
                options:{
                    indexAxis: horiz?'y':'x', 
                    maintainAspectRatio:false, 
                    responsive: true, 
                    plugins:{
                        legend:{display:false},
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 600 },
                            bodyFont: { size: 12 },
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y !== null && !horiz ? parseInt(context.parsed.y) + ' casos' : parseInt(context.parsed.x) + ' casos';
                                }
                            }
                        }
                    }, 
                    onClick:(e,el)=>{if(cb&&el.length)cb(el[0].index)}, 
                    scales:{
                        [valueAxis]: {
                            beginAtZero: true,
                            grid: { borderDash: [4, 4], color: '#f1f5f9', drawBorder: false },
                            ticks: { stepSize: 1, precision: 0, font: {size: 11} }
                        },
                        [categoryAxis]: {
                            grid: { display: false, drawBorder: false },
                            ticks: { autoSkip: false, font: {size: 11, weight: 500} } 
                        }
                    }
                }
            });
        }

        // --- Product Selection Logic ---
        window.selectProduct = function(prod) {
            document.getElementById('inpProduto').value = prod;
            const btnHDI = document.getElementById('btnHDI');
            const btnYelum = document.getElementById('btnYelum');
            
            if (prod === 'HDI') {
                btnHDI.classList.add('selected');
                btnYelum.classList.remove('selected');
            } else if (prod === 'YELUM') {
                btnYelum.classList.add('selected');
                btnHDI.classList.remove('selected');
            } else {
                btnHDI.classList.remove('selected');
                btnYelum.classList.remove('selected');
            }
        };

        // --- Modals & CRUD ---
        window.loadExistingForEdit = function(id) {
            window.closeModal('formModal');
            setTimeout(() => window.openFormModal(id), 200);
        };

        function setupSmartAlerts() {
            const assistInput = document.getElementById('inpAssistencia');
            const prestadorInput = document.getElementById('inpPrestador');
            const alertsDiv = document.getElementById('formAlerts');
            
            if(!assistInput || !prestadorInput) return;

            assistInput.addEventListener('blur', () => {
                const val = assistInput.value.trim();
                const currentId = document.getElementById('firebaseId').value;
                if(!val) return;
                const exists = npsData.find(d => String(d.assistencia) === String(val) && d.firebaseId !== currentId);
                
                if (exists) {
                    alertsDiv.innerHTML = `
                        <div class="bg-amber-50 border border-amber-200 p-4 mb-3 rounded-lg shadow-sm animate-fade-in">
                            <div class="flex items-start gap-3">
                                <div class="bg-amber-100 p-1.5 rounded-full"><i data-lucide="alert-circle" class="h-5 w-5 text-amber-600"></i></div>
                                <div class="flex-1">
                                    <p class="text-sm text-amber-900 font-bold">Assistência duplicada!</p>
                                    <p class="text-xs text-amber-700 mt-1">Este ID já consta no banco para o prestador <strong>${exists.prestador}</strong>.</p>
                                    <div class="mt-2">
                                        <button type="button" onclick="window.loadExistingForEdit('${exists.firebaseId}')" class="text-xs bg-white hover:bg-amber-50 text-amber-700 px-3 py-1.5 rounded-md border border-amber-200 shadow-sm transition-all font-medium">
                                            Abrir Registro Existente
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                    if(alertsDiv.innerHTML.includes('Assistência duplicada')) alertsDiv.innerHTML = '';
                }
            });

            prestadorInput.addEventListener('blur', () => {
                const val = prestadorInput.value.trim().toLowerCase();
                if(!val || val.length < 3) return;
                const badCount = npsData.filter(d => (d.prestador||'').toLowerCase().includes(val) && d.status === 'Procedente').length;

                if (badCount > 0) {
                     const existingAlert = alertsDiv.querySelector('.provider-alert');
                     const alertHtml = `
                        <div class="provider-alert bg-rose-50 border border-rose-200 p-3 mb-3 rounded-lg shadow-sm animate-fade-in flex items-center gap-3">
                            <div class="bg-rose-100 p-1.5 rounded-full"><i data-lucide="alert-triangle" class="h-4 w-4 text-rose-600"></i></div>
                            <div>
                                <p class="text-sm text-rose-800 font-bold">Prestador em Alerta</p>
                                <p class="text-xs text-rose-600">Histórico de <strong>${badCount}</strong> reclamações procedentes.</p>
                            </div>
                        </div>
                      `;
                      if (existingAlert) existingAlert.outerHTML = alertHtml; else alertsDiv.innerHTML += alertHtml;
                      lucide.createIcons();
                }
            });
        }

        window.openFormModal = function(id = null) {
            document.getElementById('recordForm').reset();
            document.getElementById('formAlerts').innerHTML = '';
            document.getElementById('inpAnalista').value = currentAnalista;
            window.selectProduct('');
            
            if(id) {
                const i = npsData.find(d => d.firebaseId === id);
                if(i) {
                    document.getElementById('firebaseId').value = id;
                    document.getElementById('inpAssistencia').value = i.assistencia;
                    document.getElementById('inpData').value = i.data;
                    document.getElementById('inpNota').value = i.nota;
                    document.getElementById('inpPrestador').value = i.prestador;
                    document.getElementById('inpFA').value = i.fa || '';
                    document.getElementById('inpTipoServico').value = i.tipoServico || '';
                    document.getElementById('inpCidade').value = i.cidade || '';
                    document.getElementById('inpUF').value = i.uf || '';
                    document.getElementById('inpStatus').value = i.status;
                    document.getElementById('inpMotivo').value = i.motivo;
                    document.getElementById('inpVozCliente').value = i.vozDoCliente || ''; // Novo Campo
                    document.getElementById('inpComentario').value = i.comentario;
                    document.getElementById('inpAcao').value = i.acaoRede;
                    window.selectProduct(i.produto || '');
                    document.getElementById('formModalTitle').innerHTML = `<i data-lucide="edit" class="h-4 w-4"></i> Editar Registro`;
                }
            } else { 
                document.getElementById('firebaseId').value = ""; 
                document.getElementById('formModalTitle').innerHTML = `<i data-lucide="plus-circle" class="h-4 w-4"></i> Novo Registro`;
            }
            document.getElementById('formModal').classList.remove('hidden');
            setupSmartAlerts();
            lucide.createIcons();
        };

        window.handleFormSubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('firebaseId').value;
            const rec = {
                assistencia: document.getElementById('inpAssistencia').value,
                data: document.getElementById('inpData').value,
                nota: parseInt(document.getElementById('inpNota').value),
                analista: document.getElementById('inpAnalista').value || currentAnalista,
                produto: document.getElementById('inpProduto').value, 
                cidade: document.getElementById('inpCidade').value, 
                uf: document.getElementById('inpUF').value, 
                prestador: document.getElementById('inpPrestador').value,
                fa: document.getElementById('inpFA').value,
                tipoServico: document.getElementById('inpTipoServico').value,
                status: document.getElementById('inpStatus').value,
                motivo: document.getElementById('inpMotivo').value,
                vozDoCliente: document.getElementById('inpVozCliente').value, // Novo Campo
                comentario: document.getElementById('inpComentario').value,
                acaoRede: document.getElementById('inpAcao').value
            };
            window.closeModal('formModal');
            try {
                if(id) { await updateDoc(doc(db, COLLECTION_NAME, id), rec); logAudit('UPDATE', `ID: ${rec.assistencia}`); showToast("Atualizado!", "success"); } 
                else { rec.createdAt = new Date().toISOString(); await addDoc(collection(db, COLLECTION_NAME), rec); logAudit('CREATE', `ID: ${rec.assistencia}`); showToast("Criado!", "success"); }
            } catch(err) { showToast("Erro ao salvar.", "warning"); }
        };

        window.handleExcelUpload = function(e) {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader();
            r.onload = async function(evt) {
                try {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                    // Adicionado { defval: "" } para garantir que linhas com células vazias não sejam ignoradas
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                    
                    // Log para depuração de contagem
                    console.log(`Linhas encontradas no Excel: ${rows.length}`);
                    
                    if(!rows.length) { showToast("Vazio.", "warning"); return; }
                    showToast(`Importando ${rows.length}...`, "info");
                    const promises = rows.map(r => {
                        return addDoc(collection(db, COLLECTION_NAME), {
                            assistencia: r.ID || r.Assistencia || "000",
                            nota: r.Nota || r.nota || 0,
                            data: r.Data || r.data || "-",
                            status: r.Status || r.status || "Em Análise",
                            comentario: r.Comentario || r.Obs || "",
                            vozDoCliente: r.VozCliente || r.vozDoCliente || "",
                            analista: currentAnalista,
                            prestador: r.Prestador || r.prestador || "",
                            tipoServico: r.TipoServico || r.Servico || "",
                            cidade: r.Cidade || "",
                            uf: r.UF || "",
                            produto: r.Produto || "",
                            motivo: r.Motivo || r.motivo || "",
                            fa: r.FA || r.fa || "",
                            acaoRede: r.Acao || r.acao || "",
                            createdAt: new Date().toISOString()
                        });
                    });
                    await Promise.all(promises);
                    logAudit('IMPORT', `Importou ${rows.length} registros.`);
                    showToast("Sucesso!", "success");
                } catch(err) { console.error(err); showToast("Erro importação.", "warning"); }
            };
            r.readAsArrayBuffer(f);
            e.target.value = '';
        };

        window.exportToExcel = function() {
            if(!npsData.length) { showToast("Sem dados.", "warning"); return; }
            const exportData = npsData.map(d => ({
                "ID Assistência": d.assistencia, "Data": d.data, "Nota NPS": d.nota, "Analista": d.analista, "Produto": d.produto, "Prestador": d.prestador, "Código FA": d.fa, "Cidade": d.cidade, "UF": d.uf, "Tipo de Serviço": d.tipoServico, "Status": d.status, "Motivo": d.motivo, "Ação na Rede": d.acaoRede, "Voz do Cliente": d.vozDoCliente, "Comentário Técnico": d.comentario, "Sinalizador de Risco": checkRisk(d.comentario) || checkRisk(d.vozDoCliente) ? "SIM" : "NÃO"
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Base NPS");
            XLSX.writeFile(wb, "NPS_Exportacao_v4.3.xlsx");
            showToast("Download iniciado!", "success");
        };

        window.viewDetails = (id) => {
            const i = npsData.find(d => d.firebaseId === id);
            if(!i) return;
            
            let prodBadge = i.produto;
            if(i.produto === 'HDI') prodBadge = `<span class="px-2 py-0.5 rounded-md text-xs bg-emerald-100 text-emerald-800 font-bold border border-emerald-200">HDI</span>`;
            if(i.produto === 'YELUM') prodBadge = `<span class="px-2 py-0.5 rounded-md text-xs bg-amber-100 text-amber-800 font-bold border border-amber-200">YELUM</span>`;

            document.getElementById('detailsContent').innerHTML = `
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                    <div class="flex items-center gap-3">
                         <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600 font-bold text-xl">#${i.assistencia}</div>
                         <div>
                            <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">ID do Atendimento</p>
                            <p class="text-slate-500 text-xs">${i.data || 'Data não inf.'}</p>
                         </div>
                    </div>
                    <div>${prodBadge || '<span class="text-slate-300 text-xs italic">Sem produto</span>'}</div>
                </div>
                
                <div class="grid grid-cols-2 gap-y-6 gap-x-4 mb-6">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Prestador</p>
                        <p class="font-medium text-slate-800">${i.prestador}</p>
                        <p class="text-xs text-slate-500">${i.fa ? `FA: ${i.fa}` : ''}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Localização</p>
                        <p class="font-medium text-slate-800">${i.cidade || 'N/A'} - ${i.uf || 'UF'}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Serviço</p>
                        <p class="font-medium text-slate-800">${i.tipoServico || '-'}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Status & Nota</p>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-600 font-semibold">${i.status}</span>
                            <span class="font-bold text-indigo-600">NPS ${i.nota}</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Motivo</p>
                        <p class="font-medium text-slate-800">${i.motivo}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Analista</p>
                        <p class="font-medium text-slate-800">${i.analista}</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100/50">
                        <p class="text-xs text-indigo-400 font-bold mb-2 uppercase flex items-center gap-1.5"><i data-lucide="message-circle" class="h-3.5 w-3.5"></i> Voz do Cliente</p>
                        <p class="text-sm text-slate-700 leading-relaxed italic">"${i.vozDoCliente || 'Sem registro.'}"</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-xs text-slate-400 font-bold mb-2 uppercase flex items-center gap-1.5"><i data-lucide="file-text" class="h-3.5 w-3.5"></i> Análise Técnica</p>
                        <p class="text-sm text-slate-700 leading-relaxed">${i.comentario}</p>
                    </div>
                </div>
                
                ${i.acaoRede ? `
                <div class="mt-4 pt-4 border-t border-slate-100">
                     <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Ação na Rede</p>
                     <p class="text-sm font-medium text-emerald-700 bg-emerald-50 inline-block px-2 py-1 rounded">${i.acaoRede}</p>
                </div>` : ''}
            `;
            document.getElementById('detailsModal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleSelectRow = (id) => { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); window.updateBulkUI(); };
        window.toggleSelectAll = () => { const c = document.getElementById('selectAllCheckbox').checked; document.querySelectorAll('.row-cb').forEach(cb => { cb.checked = c; if(c) selectedIds.add(cb.getAttribute('data-id')); else selectedIds.delete(cb.getAttribute('data-id')); }); window.updateBulkUI(); };
        window.updateBulkUI = () => { const btn = document.getElementById('btnDeleteSelected'); if(selectedIds.size > 0) { btn.classList.remove('hidden'); btn.classList.add('flex'); document.getElementById('selectedCountText').textContent = `Excluir (${selectedIds.size})`; } else { btn.classList.add('hidden'); btn.classList.remove('flex'); } };
        window.loadMore = () => { visibleItems += 10; refreshTable(); };
        window.clearFilters = () => { document.getElementById('searchInput').value=''; document.getElementById('filterStatus').value=''; document.getElementById('filterNota').value=''; window.clearChartFilter(); };
        window.clearChartFilter = () => { activeChartFilter=null; refreshTable(); };
        window.confirmSingleDelete = (id) => { selectedRecordId = id; document.getElementById('confirmModal').classList.remove('hidden'); document.getElementById('confirmBtnAction').onclick = async () => { window.closeModal('confirmModal'); await deleteDoc(doc(db, COLLECTION_NAME, selectedRecordId)); logAudit('DELETE', `ID: ${selectedRecordId}`); showToast('Excluído'); } };
        window.confirmBatchDelete = () => { if(!selectedIds.size) return; document.getElementById('confirmModal').classList.remove('hidden'); document.getElementById('confirmBtnAction').onclick = async () => { window.closeModal('confirmModal'); const batch = writeBatch(db); selectedIds.forEach(id => batch.delete(doc(db, COLLECTION_NAME, id))); await batch.commit(); logAudit('BATCH DELETE', `${selectedIds.size} itens`); showToast('Excluídos'); selectedIds.clear(); window.updateBulkUI(); document.getElementById('selectAllCheckbox').checked = false; } };
        window.duplicateRecord = async (id) => { const orig = npsData.find(d=>d.firebaseId===id); if(orig && confirm("Duplicar?")) { const copy={...orig}; delete copy.firebaseId; copy.createdAt=new Date().toISOString(); copy.analista=currentAnalista; await addDoc(collection(db, COLLECTION_NAME), copy); showToast("Duplicado"); } };
        window.downloadTemplate = () => { const ws = XLSX.utils.json_to_sheet([{"Assistencia":"123","Data":"01/01/2026","Nota":0,"Produto":"HDI","Cidade":"SP","UF":"SP","Prestador":"X","TipoServico":"Encanador"}]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Modelo"); XLSX.writeFile(wb, "Modelo.xlsx"); };
        
        window.openAuditModal = function() {
            const m = document.getElementById('auditModal');
            const b = document.getElementById('auditBody');
            b.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400">Carregando histórico...</td></tr>';
            m.classList.remove('hidden');
            const q = query(collection(db, COLLECTION_LOGS), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(q, (s) => {
                b.innerHTML = s.empty ? '<tr><td colspan="4" class="p-8 text-center text-slate-400">Sem logs recentes.</td></tr>' : '';
                s.forEach(d => {
                    const l = d.data();
                    let actionClass = 'bg-slate-100 text-slate-600';
                    if(l.action.includes('CREATE')) actionClass = 'bg-indigo-100 text-indigo-700';
                    if(l.action.includes('DELETE')) actionClass = 'bg-rose-100 text-rose-700';
                    if(l.action.includes('UPDATE')) actionClass = 'bg-amber-100 text-amber-700';

                    b.innerHTML += `
                        <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-colors">
                            <td class="p-3 text-xs text-slate-400 font-mono">${new Date(l.timestamp).toLocaleString()}</td>
                            <td class="p-3 text-xs font-bold text-slate-700">${l.user}</td>
                            <td class="p-3"><span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider ${actionClass}">${l.action}</span></td>
                            <td class="p-3 text-xs text-slate-500 truncate max-w-[200px]">${l.details}</td>
                        </tr>`;
                });
            });
        };

        window.performLogin = function() {
            const n = document.getElementById('loginName').value;
            const p = document.getElementById('loginPin').value;
            if(!n) return alert("Nome obrigatório");
            // Simple PIN check for demo purposes
            if(p !== "1234") return alert("Pin incorreto (Dica: 1234)");
            
            currentAnalista = n;
            localStorage.setItem('nps_user_name', n);
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('userNameDisplay').textContent = getInitials(n);
            initAppLogic();
        };
        window.logout = () => { if(confirm("Sair?")) { localStorage.removeItem('nps_user_name'); location.reload(); } };

        if(currentAnalista) {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('userNameDisplay').textContent = getInitials(currentAnalista);
            initAppLogic();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            ['searchInput','filterStatus','filterNota','filterDateStart','filterDateEnd'].forEach(id=>document.getElementById(id).addEventListener('input',()=>refreshTable()));
        });
    </script>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden bg-slate-50">

    <!-- Login Modal (Modernized) -->
    <div id="loginModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm transition-all duration-500">
        <div class="relative w-full max-w-md bg-white rounded-3xl shadow-2xl p-10 overflow-hidden">
             <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
             <div class="mb-8 text-center">
                 <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-6 transform rotate-3 shadow-inner">
                    <i data-lucide="shield-check" class="h-8 w-8 text-indigo-600"></i>
                 </div>
                 <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">NPS Cloud</h2>
                 <p class="text-slate-400 mt-2 text-sm font-medium">Acesso Seguro ao Dashboard</p>
             </div>
             
             <div class="space-y-5">
                 <div class="group">
                     <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Analista</label>
                     <div class="relative">
                         <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-300 group-focus-within:text-indigo-500 transition-colors">
                             <i data-lucide="user" class="h-5 w-5"></i>
                         </div>
                         <input type="text" id="loginName" placeholder="Seu Nome" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all font-medium placeholder-slate-300">
                     </div>
                 </div>
                 
                 <div class="group">
                     <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Pin de Acesso</label>
                     <div class="relative">
                         <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-300 group-focus-within:text-indigo-500 transition-colors">
                             <i data-lucide="lock" class="h-5 w-5"></i>
                         </div>
                         <input type="password" id="loginPin" maxlength="4" placeholder="••••" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-lg tracking-widest font-bold placeholder-slate-300">
                     </div>
                 </div>

                 <button onclick="performLogin()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2 mt-4">
                    <span>Entrar</span>
                    <i data-lucide="arrow-right" class="h-4 w-4 opacity-70"></i>
                 </button>
             </div>
             
             <div class="mt-8 text-center">
                <p class="text-xs text-slate-300">Versão 4.7 • Build 2026</p>
             </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-2xl p-8 text-center w-full max-w-sm shadow-2xl border border-white/20">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="h-6 w-6 text-red-500"></i>
            </div>
            <h3 class="font-bold text-lg mb-2 text-slate-800">Confirmar Ação?</h3>
            <p id="confirmText" class="mb-6 text-sm text-slate-500">Essa ação não poderá ser desfeita.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('confirmModal')" class="px-5 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-medium transition-colors">Cancelar</button>
                <button id="confirmBtnAction" class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium shadow-lg shadow-red-500/30 transition-all">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div id="auditModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-2xl w-full max-w-2xl flex flex-col max-h-[80vh] shadow-2xl border border-slate-100 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <span class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="history" class="h-5 w-5 text-indigo-500"></i> Log de Auditoria</span>
                <button onclick="closeModal('auditModal')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <div class="overflow-auto flex-grow custom-scroll bg-white">
                <table class="w-full">
                    <thead class="bg-slate-50 text-xs text-slate-400 uppercase tracking-wider sticky top-0 z-10">
                        <tr><th class="p-3 text-left pl-6">Data</th><th class="p-3 text-left">Usuário</th><th class="p-3 text-left">Ação</th><th class="p-3 text-left">Detalhes</th></tr>
                    </thead>
                    <tbody id="auditBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-2xl w-full max-w-2xl flex flex-col max-h-[90vh] shadow-2xl border border-white/20 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white">
                <span class="font-bold text-lg text-slate-800">Detalhes do Registro</span>
                <button onclick="closeModal('detailsModal')" class="bg-slate-100 p-2 rounded-full hover:bg-slate-200 transition-colors"><i data-lucide="x" class="h-5 w-5 text-slate-500"></i></button>
            </div>
            <div class="p-8 overflow-y-auto custom-scroll" id="detailsContent"></div>
        </div>
    </div>

    <!-- Form Modal (Refined) -->
    <div id="formModal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in flex flex-col max-h-[90vh] border border-slate-200">
            <div class="px-6 py-5 bg-white border-b border-slate-100 flex justify-between items-center flex-none">
                <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2" id="formModalTitle">Registro</h3>
                <button onclick="closeModal('formModal')" class="bg-slate-50 p-2 rounded-full hover:bg-slate-100 text-slate-500 transition-colors"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <form id="recordForm" onsubmit="handleFormSubmit(event)" class="p-6 space-y-5 overflow-y-auto custom-scroll flex-grow bg-white">
                <input type="hidden" id="firebaseId"><input type="hidden" id="editIndex"><input type="hidden" id="inpProduto">
                
                <div id="formAlerts" class="mb-2"></div>

                <div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wide text-center">Selecione o Produto</label>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" id="btnHDI" onclick="selectProduct('HDI')" class="btn-prod btn-hdi py-3.5 rounded-xl flex items-center justify-center gap-2 font-medium text-slate-600 bg-white">
                            HDI
                        </button>
                        <button type="button" id="btnYelum" onclick="selectProduct('YELUM')" class="btn-prod btn-yelum py-3.5 rounded-xl flex items-center justify-center gap-2 font-medium text-slate-600 bg-white">
                             YELUM
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">ID Assistência</label>
                        <input type="number" id="inpAssistencia" required class="w-full border border-slate-200 p-2.5 rounded-lg text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Data</label>
                        <input type="text" id="inpData" placeholder="DD/MM/AAAA" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm focus:border-indigo-500 outline-none">
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-5">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Cidade</label>
                        <input type="text" id="inpCidade" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">UF</label>
                        <input type="text" id="inpUF" maxlength="2" placeholder="SP" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm uppercase text-center focus:border-indigo-500 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Nota NPS</label>
                        <input type="number" id="inpNota" required min="0" max="10" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Analista</label>
                        <input type="text" id="inpAnalista" readonly class="w-full border border-slate-200 p-2.5 rounded-lg text-sm bg-slate-100 text-slate-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Cód. FA</label>
                        <input type="text" id="inpFA" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Prestador</label>
                        <input type="text" id="inpPrestador" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm focus:border-indigo-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Tipo de Serviço</label>
                    <input type="text" id="inpTipoServico" placeholder="Ex: Linha Branca" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm focus:border-indigo-500 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Status</label>
                        <select id="inpStatus" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm bg-white focus:border-indigo-500 outline-none">
                            <option value="Procedente">Procedente</option>
                            <option value="Improcedente">Improcedente</option>
                            <option value="Neutra">Neutra</option>
                            <option value="Em Análise">Em Análise</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Motivo</label>
                        <select id="inpMotivo" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm bg-white focus:border-indigo-500 outline-none">
                            <option value="">Selecione...</option>
                            <option value="Visita não realizada">Visita não realizada</option>
                            <option value="Demora no envio do orçamento">Demora no envio do orçamento</option>
                            <option value="Cobertura">Cobertura</option>
                            <option value="Falha operacional">Falha operacional</option>
                            <option value="Atraso">Atraso</option>
                            <option value="Procedimento incorreto">Procedimento incorreto</option>
                            <option value="Envio de checklist">Envio de checklist</option>
                            <option value="Desqualificação">Desqualificação</option>
                            <option value="Falta de posicionamento">Falta de posicionamento</option>
                            <option value="Postura">Postura</option>
                            <option value="Percepção">Percepção</option>
                            <option value="Estrutura deficitária da rede">Estrutura deficitária da rede</option>
                            <option value="Cancelamento de atendimento">Cancelamento de atendimento</option>
                            <option value="Sem falha do prestador / operação">Sem falha do prestador / operação</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>

                <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-500 mb-1.5 uppercase ml-1 flex items-center gap-1.5">
                        <i data-lucide="message-circle" class="h-3.5 w-3.5"></i> Voz do Cliente
                    </label>
                    <textarea id="inpVozCliente" rows="2" placeholder="O que o cliente disse exatamente?" class="w-full border border-indigo-200 p-2.5 rounded-lg text-sm resize-none bg-white focus:border-indigo-500 outline-none transition-all placeholder-indigo-200"></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Comentário Técnico</label>
                    <textarea id="inpComentario" rows="3" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm resize-none focus:border-indigo-500 outline-none"></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase ml-1">Ação na Rede</label>
                    <input type="text" id="inpAcao" class="w-full border border-slate-200 p-2.5 rounded-lg text-sm focus:border-indigo-500 outline-none">
                </div>
                
                <div class="pt-2">
                    <button type="submit" class="w-full bg-slate-900 text-white p-3.5 rounded-xl hover:bg-slate-800 font-bold shadow-lg shadow-slate-300 transform transition-all hover:-translate-y-0.5">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <!-- Nav -->
    <nav class="bg-slate-900 text-white shadow-xl z-30 flex-none sticky top-0 border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="bg-white/10 p-2.5 rounded-xl backdrop-blur-sm border border-white/5 shadow-inner">
                    <i data-lucide="cloud" class="h-6 w-6 text-indigo-400"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white">NPS Cloud <span class="text-indigo-400 font-light">4.7</span></h1>
                    <p class="text-[10px] text-slate-400 flex items-center gap-1.5 uppercase tracking-wider font-semibold"><span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span> Online System</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="openAuditModal()" class="flex items-center space-x-2 bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded-lg text-xs font-medium border border-slate-700 text-slate-200 transition-colors"><i data-lucide="history" class="h-4 w-4 text-indigo-400"></i><span class="hidden md:inline">Logs</span></button>
                
                <div class="h-6 w-px bg-slate-700 mx-1"></div>
                
                <button onclick="downloadTemplate()" class="hidden md:flex items-center space-x-2 bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded-lg text-xs font-medium border border-slate-700 text-slate-200 transition-colors"><i data-lucide="download" class="h-4 w-4 text-indigo-400"></i><span>Modelo</span></button>
                <button onclick="exportToExcel()" class="hidden md:flex items-center space-x-2 bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-lg text-xs font-medium shadow-lg shadow-emerald-900/20 border border-emerald-500 transition-all transform hover:-translate-y-0.5"><i data-lucide="file-spreadsheet" class="h-4 w-4"></i><span>Excel</span></button>
                
                <div class="h-8 w-1 bg-slate-700 mx-2 rounded-full"></div>
                
                <button onclick="logout()" class="flex items-center justify-center w-9 h-9 bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 rounded-lg transition-colors border border-rose-500/20" title="Sair"><i data-lucide="log-out" class="h-4 w-4"></i></button>
                <div id="userNameDisplay" class="h-10 w-10 rounded-xl bg-indigo-600 flex items-center justify-center border-2 border-indigo-400/30 font-bold text-sm shadow-lg text-white cursor-help">--</div>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <main class="container mx-auto px-6 py-8 flex-grow overflow-y-auto custom-scroll">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
            <div>
                 <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><i data-lucide="layout-dashboard" class="h-6 w-6 text-indigo-600"></i>Visão Estratégica</h2>
                 <p class="text-sm text-slate-500 mt-1 pl-9">Monitoramento de qualidade e performance em tempo real.</p>
            </div>
            
            <div class="flex space-x-3 w-full md:w-auto bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelUpload(event)">
                <button id="btnDeleteSelected" onclick="confirmBatchDelete()" class="hidden flex items-center bg-rose-50 text-rose-600 px-4 py-2 rounded-xl text-sm font-bold border border-rose-100 hover:bg-rose-100 transition-colors"><i data-lucide="trash-2" class="h-4 w-4 mr-2"></i><span id="selectedCountText">Excluir</span></button>
                
                <button onclick="document.getElementById('excelInput').click()" class="flex items-center text-slate-600 hover:bg-slate-50 px-4 py-2.5 rounded-xl text-sm font-medium transition-colors"><i data-lucide="upload-cloud" class="h-4 w-4 mr-2 text-indigo-500"></i>Importar</button>
                <button onclick="openFormModal()" class="flex items-center bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-md shadow-slate-300 transition-all transform hover:scale-105"><i data-lucide="plus" class="h-4 w-4 mr-2"></i>Novo Registro</button>
            </div>
        </div>

        <!-- Dashboard KPIs (Modern Cards) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card-modern p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-indigo-50 to-transparent opacity-50"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Total Geral</p>
                        <h3 class="text-4xl font-extrabold text-slate-800 tracking-tight" id="kpi-total">0</h3>
                    </div>
                    <div class="bg-indigo-50 p-3 rounded-2xl text-indigo-600 group-hover:scale-110 transition-transform"><i data-lucide="layers" class="h-6 w-6"></i></div>
                </div>
            </div>

            <div class="card-modern p-6 relative overflow-hidden group border-l-4 border-l-rose-500">
                <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-rose-50 to-transparent opacity-50"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Procedentes</p>
                        <div class="flex items-baseline gap-2">
                             <h3 class="text-4xl font-extrabold text-rose-600 tracking-tight" id="kpi-procedente">0</h3>
                             <span class="text-xs font-bold text-rose-600 bg-rose-100 px-2 py-0.5 rounded-md" id="kpi-procedente-pct">0%</span>
                        </div>
                    </div>
                    <div class="bg-rose-50 p-3 rounded-2xl text-rose-500 group-hover:scale-110 transition-transform"><i data-lucide="alert-circle" class="h-6 w-6"></i></div>
                </div>
            </div>
            
            <!-- Improcedentes KPI (Substitute) -->
            <div class="card-modern p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-emerald-50 to-transparent opacity-50"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Improcedentes</p>
                        <div class="flex items-baseline gap-2">
                             <h3 class="text-4xl font-extrabold text-emerald-600 tracking-tight" id="kpi-improcedente">0</h3>
                             <span class="text-xs font-bold text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-md" id="kpi-improcedente-pct">0%</span>
                        </div>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-2xl text-emerald-500 group-hover:scale-110 transition-transform"><i data-lucide="thumbs-up" class="h-6 w-6"></i></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="card-modern p-6 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-bold uppercase text-slate-500 tracking-wide flex items-center gap-2"><i data-lucide="bar-chart-2" class="h-4 w-4 text-indigo-500"></i> Top 5 Motivos (Procedentes)</h3>
                    <button onclick="clearChartFilter()" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded transition-colors uppercase tracking-wide">Limpar Filtro</button>
                </div>
                <div class="chart-container flex-grow" style="height: 280px;"><canvas id="chartMotivos"></canvas></div>
            </div>
            
            <div class="card-modern p-6 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-bold uppercase text-slate-500 tracking-wide flex items-center gap-2"><i data-lucide="alert-octagon" class="h-4 w-4 text-rose-500"></i> Ofensores (Procedentes)</h3>
                </div>
                <div class="chart-container flex-grow" style="height: 280px;"><canvas id="chartPrestadores"></canvas></div>
            </div>
        </div>

        <div class="card-modern overflow-hidden mb-8 flex flex-col h-[600px]">
            <div class="p-5 border-b border-slate-100 bg-white sticky top-0 z-20">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                    <div class="md:col-span-5 relative group">
                        <i data-lucide="search" class="absolute left-3.5 top-2.5 h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por ID, Prestador, Cidade..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm transition-all shadow-sm">
                    </div>
                    <div class="md:col-span-2">
                        <select id="filterStatus" class="w-full py-2.5 px-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white text-sm outline-none focus:border-indigo-500 transition-all cursor-pointer">
                            <option value="">Todos Status</option>
                            <option value="Em Análise">Em Análise</option>
                            <option value="Procedente">Procedente</option>
                            <option value="Improcedente">Improcedente</option>
                            <option value="Neutra">Neutra</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <input type="number" id="filterNota" min="0" max="10" placeholder="Nota (0-10)" class="w-full py-2.5 px-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white text-sm outline-none focus:border-indigo-500 transition-all">
                    </div>
                    <div class="md:col-span-3 flex gap-2">
                        <input type="date" id="filterDateStart" class="w-full text-xs border border-slate-200 bg-slate-50 rounded-xl p-2 outline-none focus:border-indigo-500">
                        <input type="date" id="filterDateEnd" class="w-full text-xs border border-slate-200 bg-slate-50 rounded-xl p-2 outline-none focus:border-indigo-500">
                    </div>
                </div>
            </div>
            
            <div class="overflow-auto custom-scroll relative flex-grow bg-white">
                <div id="loadingIndicator" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex flex-col items-center justify-center font-bold text-slate-500 fade-in"><i data-lucide="loader-2" class="animate-spin h-8 w-8 mb-3 text-indigo-600"></i><span>Sincronizando dados...</span></div>
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-4 w-12 text-center border-b border-slate-200"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="custom-checkbox"></th>
                            <th class="p-4 cursor-pointer hover:text-indigo-600 border-b border-slate-200 transition-colors" onclick="window.sortTable('assistencia')">ID <i data-lucide="arrow-up-down" class="sort-icon inline align-middle"></i></th>
                            <th class="p-4 cursor-pointer hover:text-indigo-600 border-b border-slate-200 transition-colors" onclick="window.sortTable('data')">Data <i data-lucide="arrow-up-down" class="sort-icon inline align-middle"></i></th>
                            <th class="p-4 border-b border-slate-200">Nota</th>
                            <th class="p-4 border-b border-slate-200">Local</th>
                            <th class="p-4 border-b border-slate-200">FA / Prestador</th>
                            <th class="p-4 border-b border-slate-200">Serviço</th>
                            <th class="p-4 cursor-pointer hover:text-indigo-600 border-b border-slate-200 transition-colors" onclick="window.sortTable('status')">Status <i data-lucide="arrow-up-down" class="sort-icon inline align-middle"></i></th>
                            <th class="p-4 cursor-pointer hover:text-indigo-600 border-b border-slate-200 transition-colors" onclick="window.sortTable('analista')">Analista <i data-lucide="arrow-up-down" class="sort-icon inline align-middle"></i></th>
                            <th class="p-4 text-right border-b border-slate-200">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm divide-y divide-slate-50 bg-white"></tbody>
                </table>
            </div>
            
            <div class="p-4 border-t border-slate-100 text-center bg-slate-50 flex flex-col items-center justify-center flex-none">
                <p class="text-xs text-slate-400 mb-3 font-medium" id="showingCount">Carregando...</p>
                <button id="loadMoreBtn" onclick="loadMore()" class="text-indigo-600 text-xs font-bold hidden px-6 py-2.5 border border-indigo-200 hover:bg-indigo-50 rounded-full bg-white shadow-sm transition-all hover:-translate-y-0.5">Carregar Mais Registros</button>
            </div>
        </div>
    </main>
</body>
</html>
